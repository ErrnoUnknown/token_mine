<!DOCTYPE html>
<html>
    <head>
        <!-- Config title -->
        <title>토큰 광산 테스트</title>

        <!-- Load Pyscript -->
        <link rel="stylesheet" href="static/css/pyscript.css" />
        <script defer src="static/js/pyscript.js"></script>
        
        <!-- Load Bootstrap -->
        <link href="static/css/bootstrap.css" rel="stylesheet">

        <!-- Init Python -->
        <py-script>
            # Import
            import asyncio
            from datetime import datetime
            import math

            # Define functions
            def add_token():
                global tokens, last_reward_time, last_click_time, click_intervals, MAX_CLICK_PER_SEC

                click_intervals.append(math.floor((datetime.now() - last_click_time).total_seconds() * 10) / 10)
                click_intervals = click_intervals[-100:]

                last_click_time = datetime.now()

                if len(click_intervals) == 100 and len(list(set(click_intervals))) == 1:
                    Element("main-alert").write("매크로가 감지되었습니다.")

                if (datetime.now() - last_reward_time).total_seconds() > (1 / MAX_CLICK_PER_SEC):
                    last_reward_time = datetime.now()
                    tokens += 1
                    Element("token_rewards").write(f"{tokens} 토큰")

            # Set constants
            MAX_CLICK_PER_SEC = 5

            # Init variables
            tokens = 0
            last_reward_time = datetime.now()
            last_click_time = datetime.now()
            click_intervals = []
        </py-script>
    </head>
    <body style="background-color: #313338;">
        <!-- Navbar -->
        <nav class="navbar navbar-dark">
            <a class="navbar-brand" href="https://discord.com/channels/1124570328023175180/1143911353187315803">
                <img src="static/image/discord_logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
                <img src="static/image/token_bot_logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
                토큰 광산
            </a>
        </nav>

        <!-- Token mine -->
        <br>
        <div class="container-fluid">
            <div class="alert alert-danger" role="alert" id="main-alert"></div>
            <div class="alert alert-info" role="alert" id="token_rewards">
                0 토큰
            </div>
            <div class="d-flex justify-content-center">
                <button py-click="add_token()" type="button" class="btn btn-primary btn-lg">토큰 얻기</button>
            </div>
        </div>

        <!-- Claim -->
        <br>

        <div class="container-fluid">
            <br>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="input-discord-handle">디스코드 핸들</span>
                </div>
                <input type="text" class="form-control" placeholder="이곳에 입력" aria-label="Username" aria-describedby="basic-addon1">
            </div>
        </div>

        <!-- Script -->
        <py-script>
            a = 1
        </py-script>

        <script>
            if (localStorage.getItem('myPageLoaded')) {
              window.close();
            } else {
              localStorage.setItem('myPageLoaded', 'true');
              window.addEventListener('beforeunload', function () {
                localStorage.removeItem('myPageLoaded');
              });
            }
          </script>
    </body>
</html>